name: Deploy Greenplate on AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

env:
  AWS_REGION: af-south-1
  PYTHON_VERSION: '3.11'
  PROJECT_NAME: greenplate
  ENV_NAME: dev

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies & Package
        run: |
          echo "Packaging Backend..."
          cd backend
          
          # Create package directory
          mkdir -p package
          
          # Install libraries to package folder
          pip install -r requirements.txt -t ./package
          
          # Copy application code
          cp app.py ./package/
          
          # Zip it up (cd into package so zip doesn't include 'package' folder parent)
          cd package
          zip -r ../lambda_function.zip .
          cd ..
          
          echo "Package created: lambda_function.zip"

      - name: Update Lambda Code
        run: |
          echo "Deploying to Lambda: ${{ env.PROJECT_NAME }}-api-${{ env.ENV_NAME }}"
          
          aws lambda update-function-code \
            --function-name ${{ env.PROJECT_NAME }}-api-${{ env.ENV_NAME }} \
            --zip-file fileb://backend/lambda_function.zip
          
          echo "Lambda update initiated."

  deploy-frontend:
    needs: deploy-backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Fetch API URL & Create Config
        run: |
          # 1. Get the API ID using AWS CLI
          API_ID=$(aws apigateway get-rest-apis --query "items[?name=='${{ env.PROJECT_NAME }}-api-${{ env.ENV_NAME }}'].id" --output text)
          
          # 2. Construct the URL
          API_URL="https://${API_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ENV_NAME }}/api"
          
          echo "Found API URL: $API_URL"
          
          # 3. Create config.js for the frontend
          cd frontend
          echo "window.config = { apiUrl: '$API_URL' };" > config.js
          
          echo "Created config.js"

      - name: Sync to S3
        run: |
          BUCKET_NAME="${{ env.PROJECT_NAME }}-frontend-${{ env.ENV_NAME }}"
          
          echo "Deploying to Bucket: $BUCKET_NAME"
          
          # Sync frontend folder to S3
          aws s3 sync ./frontend s3://$BUCKET_NAME/ --delete
          
      - name: Invalidate CloudFront
        run: |
          # Find the Distribution ID by matching the tag (Name = greenplate-cloudfront)
          # Note: If you have multiple, this might need adjustment, but tags are safest.
          DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Comment=='${{ env.PROJECT_NAME }} frontend distribution'].Id" --output text)
          
          echo "Invalidating Cache for Distribution: $DIST_ID"
          
          aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*"